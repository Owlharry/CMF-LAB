<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CMF LAB</title>
    
    <!-- 引入 React 核心库 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'blob': 'float 20s infinite ease-in-out',
                        'shimmer': 'shimmer 1.5s infinite',
                        'slideUpSpring': 'slideUpSpring 0.5s cubic-bezier(0.32, 0.72, 0, 1) forwards',
                        'slideDownSpring': 'slideDownSpring 0.5s cubic-bezier(0.32, 0.72, 0, 1) forwards',
                        'fadeIn': 'fadeIn 0.5s ease-out',
                        'scaleDown': 'scaleDown 0.5s cubic-bezier(0.32, 0.72, 0, 1) forwards',
                        'scaleUp': 'scaleUp 0.5s cubic-bezier(0.32, 0.72, 0, 1) forwards',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.2)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.8)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        shimmer: {
                            '100%': { transform: 'translateX(100%)' },
                        },
                        slideUpSpring: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        slideDownSpring: {
                            '0%': { transform: 'translateY(0)' },
                            '100%': { transform: 'translateY(100%)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        scaleDown: {
                            '0%': { transform: 'scale(1)', borderRadius: '0px' },
                            '100%': { transform: 'scale(0.94)', borderRadius: '24px', opacity: '0.8' },
                        },
                        scaleUp: {
                            '0%': { transform: 'scale(0.94)', borderRadius: '24px', opacity: '0.8' },
                            '100%': { transform: 'scale(1)', borderRadius: '0px', opacity: '1' },
                        }
                    },
                    fontFamily: {
                        sans: ['SF Pro Display', 'Inter', 'system-ui', '-apple-system', 'sans-serif'],
                        mono: ['SF Mono', 'JetBrains Mono', 'monospace'],
                    },
                    backgroundImage: {
                        'tech-grid': "linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px)",
                    }
                }
            }
        }
    </script>

    <style>
        /* APP 专属样式修正 */
        html, body {
            background-color: #050505;
            color: #fff;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* 允许输入框选中 */
        input, textarea {
            -webkit-user-select: auto;
            user-select: auto;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .glass-card {
            background: rgba(20, 20, 23, 0.4);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        /* iOS Modal Backdrop */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .liquid-text {
            background: linear-gradient(to right, #22d3ee, #e879f9, #22d3ee);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 200% auto;
            animation: shine 5s linear infinite;
        }

        .tech-bg-grid {
            background-size: 40px 40px;
            mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
        }

        @keyframes shine {
            to { background-position: 200% center; }
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 图标组件 ---
        const Icon = ({ name, size = 18, className = "" }) => {
            const icons = {
                Upload: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" />,
                X: <path d="M18 6 6 18M6 6l12 12" />,
                ArrowRight: <path d="M5 12h14M12 5l7 7-7 7" />,
                Zap: <path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z" />,
                Droplet: <path d="M12 22a7 7 0 0 0 7-7c0-2-2.39-4.75-2.39-4.75a7.6 7.6 0 0 0-9.22 0S5 13 5 15a7 7 0 0 0 7 7ZM12 9s-2-2.5-2-4.5A2 2 0 0 1 12 2a2 2 0 0 1 2 2.5c0 2-2 4.5-2 4.5Z" />,
                Layers: <><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z" /><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65" /><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65" /></>,
                Eye: <><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></>,
                Maximize2: <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" />,
                AlertCircle: <><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></>,
                Plus: <path d="M5 12h14M12 5v14" />,
                CarFront: <><path d="m21 8-2 2-1.5-3.7A2 2 0 0 0 15.646 5H8.4a2 2 0 0 0-1.903 1.257L5 10 3 8" /><path d="M7 14h.01" /><path d="M17 14h.01" /><rect width="18" height="8" x="3" y="10" rx="2" /><path d="M5 18v2" /><path d="M19 18v2" /></>,
                Settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></>,
                Check: <path d="M20 6 9 17l-5-5" />,
                Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>,
                Sparkles: <><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z" /><path d="M5 3v4" /><path d="M9 5H5" /><path d="M20 17h-4" /><path d="M18 15v4" /></>,
                ChevronRight: <path d="m9 18 6-6-6-6" />,
                Globe: <circle cx="12" cy="12" r="10" />,
                Palette: <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z" />,
            };
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                >
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        // --- 全局常量 ---
        const APP_TITLE = "CMF";
        const APP_SUFFIX = "LAB";
        const APP_VERSION = "v9.0.0-NextGen";

        // --- 模型配置 ---
        // 将所有 gemini 模型的 type 改为 custom，强制显示输入框，因为 Client-side 必须要有 Key
        const MODEL_OPTIONS = {
          analysis: [
            { 
                id: 'gemini_default', 
                name: 'Gemini 3.5 Pro', 
                type: 'custom', 
                provider: 'gemini',
                realModel: 'gemini-3.5-pro' 
            },
            { 
                id: 'chatgpt', 
                name: 'GPT-5.2 (Vision)', 
                type: 'custom', 
                provider: 'openai', 
                baseUrl: 'https://api.openai.com/v1', 
                realModel: 'gpt-5.2' 
            },
            { 
                id: 'qwen', 
                name: 'Qwen 3.5 Plus (Vision)', 
                type: 'custom', 
                provider: 'openai', 
                baseUrl: 'https://dashscope.aliyuncs.com/compatible-mode/v1', 
                realModel: 'qwen3.5-plus' 
            },
            { 
                id: 'doubao', 
                name: 'Doubao Seed 2.0 (Vision)', 
                type: 'custom', 
                provider: 'openai', 
                baseUrl: 'https://ark.cn-beijing.volces.com/api/v3', 
                realModel: 'doubao-seed-2.0' 
            },
            { 
                id: 'kimi', 
                name: 'Kimi k2.5 (Vision)', 
                type: 'custom', 
                provider: 'openai', 
                baseUrl: 'https://api.moonshot.cn/v1', 
                realModel: 'kimi-k2.5' 
            },
          ],
          rendering: [
            { 
                id: 'gemini_default', 
                name: 'Gemini 3.5 Pro', 
                type: 'custom', 
                provider: 'gemini',
                realModel: 'gemini-3.5-pro' 
            },
            { 
                id: 'chatgpt', 
                name: 'GPT-5.2 (Paint)', 
                type: 'custom', 
                provider: 'openai', 
                baseUrl: 'https://api.openai.com/v1', 
                realModel: 'gpt-5.2' 
            },
            { 
                id: 'kling', 
                name: 'Kling Video o1 (可灵)', 
                type: 'custom', 
                provider: 'openai', 
                baseUrl: 'https://api.klingai.com/v1',
                realModel: 'kling-video-o1' 
            },
            { 
                id: 'qwen', 
                name: 'Qwen 3.5 Plus (Paint)', 
                type: 'custom', 
                provider: 'openai', 
                baseUrl: 'https://dashscope.aliyuncs.com/compatible-mode/v1', 
                realModel: 'qwen3.5-plus' 
            },
            { 
                id: 'doubao', 
                name: 'Doubao Seed 2.0 (Paint)', 
                type: 'custom', 
                provider: 'openai', 
                baseUrl: 'https://ark.cn-beijing.volces.com/api/v3', 
                realModel: 'doubao-seed-2.0' 
            },
          ]
        };

        // --- 核心业务逻辑 ---

        const fetchWithTimeout = async (url, options, timeout = 30000) => {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            const response = await fetch(url, {
                ...options,
                signal: controller.signal
            });
            clearTimeout(id);
            return response;
        };
        
        const analyzePaintCMF = async (referenceImagesBase64, config) => {
          const { providerId, apiKey } = config;
          const currentModel = MODEL_OPTIONS.analysis.find(m => m.id === providerId);
          
          const validImages = referenceImagesBase64.filter(img => img !== null);
          if (validImages.length === 0) throw new Error("请至少上传一张参考图");

          // System Prompt
          const systemPrompt = `
            你是一名专业的CMF色彩工程师和涂装工艺工程师，精通创作出具有吸引力，有强烈张力的，风格多样，质感丰富的车漆。
            需要你先从涂装工艺的专业角度去分析用户上传的图片中车辆的车漆，并且综合车型轮廓、环境光折射等等方面。

            请输出严格的JSON格式 (不要输出Markdown代码块，只输出纯JSON)，必须包含以下字段：
            {
                "color_name": "中文商业命名 + 英文专业命名",
                "hsv_analysis": "色相(Hue)、明度(Value)、饱和度(Saturation)的具体描述",
                "paint_type": "漆种类型 (素色/金属/珠光/变色/哑光漆/糖果漆 等)",
                "flake_character": "颗粒特征 (粗细/密度/颜色/闪烁度 等)",
                "travel_effect": "随角异色 (Face Tone 正面/Flop Tone 侧面)",
                "gloss_level": "光泽等级 (高光/缎面/哑光/半哑光 等)",
                "visual_texture": "视觉质感 (如液态金属感、陶瓷感、磨砂感、丝绸感 等)",
                "synthesis_prompt": "用于AI生图的英文Prompt，详细描述车漆的所有物理属性，强调 photorealistic automotive paint, 8k resolution"
            }
          `;
          const userPrompt = `基于这 ${validImages.length} 张图，进行深度车漆CMF分析。`;

          if (currentModel.provider === 'gemini') {
             if (!apiKey) throw new Error("Gemini 默认模式也需要配置 API Key 才能在浏览器运行");
             return await callGeminiAnalysis(userPrompt, systemPrompt, validImages, apiKey, currentModel.realModel); 
          } else if (currentModel.provider === 'openai') {
             if (!apiKey) throw new Error(`请配置 ${currentModel.name} API Key`);
             return await callOpenAICompatibleAnalysis(userPrompt, systemPrompt, validImages, apiKey, currentModel.baseUrl, currentModel.realModel);
          } else {
             throw new Error("暂不支持该模型协议");
          }
        };

        const renderCarPaint = async (targetImageBase64, cmfData, config) => {
          const { providerId, apiKey } = config;
          const currentModel = MODEL_OPTIONS.rendering.find(m => m.id === providerId);

          const prompt = `
            Action: Repaint the car.
            Style: Photorealistic 8k automotive photography.
            Paint Characteristics:
            - Type: ${cmfData.paint_type}
            - Color: ${cmfData.hsv_analysis}
            - Flakes: ${cmfData.flake_character}
            - Travel/Flop: ${cmfData.travel_effect}
            - Gloss: ${cmfData.gloss_level}
            - Texture: ${cmfData.visual_texture}
            
            Specific Generation Prompt: ${cmfData.synthesis_prompt}
            
            Constraint: Maintain car shape, lighting, background exactly. Only change the car paint material.
          `;

          if (currentModel.provider === 'gemini') {
             if (!apiKey) throw new Error("Gemini 默认模式也需要配置 API Key");
             return await callGeminiRendering(prompt, targetImageBase64, apiKey, currentModel.realModel);
          } else if (currentModel.provider === 'openai') {
             if (!apiKey) throw new Error(`请配置 ${currentModel.name} API Key`);
             return await callOpenAICompatibleRendering(prompt, targetImageBase64, apiKey, currentModel.baseUrl, currentModel.realModel);
          } else {
             throw new Error("暂不支持该模型协议");
          }
        };

        // --- 真实 API 调用实现 ---

        const callGeminiAnalysis = async (userPrompt, systemPrompt, images, apiKey, modelName) => {
          const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
          const contentParts = [{ text: userPrompt }, ...images.map(img => ({ inlineData: { mimeType: "image/jpeg", data: img } }))];
          
          try {
              const response = await fetchWithTimeout(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ role: "user", parts: contentParts }], systemInstruction: { parts: [{ text: systemPrompt }] }, generationConfig: { responseMimeType: "application/json" } })
              }, 30000); 
              
              if (!response.ok) {
                  const err = await response.json().catch(()=>({}));
                  throw new Error(`Gemini Error: ${err.error?.message || response.statusText} (请检查 API Key)`);
              }
              const data = await response.json();
              return JSON.parse(data.candidates[0].content.parts[0].text);
          } catch (e) {
              if (e.name === 'AbortError') throw new Error("请求超时，请检查网络");
              throw e;
          }
        };

        const callGeminiRendering = async (prompt, imageBase64, apiKey, modelName) => {
          const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
          
          try {
              const response = await fetchWithTimeout(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: imageBase64 } }] }], generationConfig: { responseModalities: ["IMAGE"] } })
              }, 45000); 
              
              if (!response.ok) {
                 const err = await response.json().catch(()=>({}));
                 throw new Error(`Gemini Render Error: ${err.error?.message || response.statusText}`);
              }
              const data = await response.json();
              const generatedImage = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
              if (!generatedImage) throw new Error("未能生成图像");
              return generatedImage;
          } catch (e) {
              if (e.name === 'AbortError') throw new Error("渲染超时，请检查网络");
              throw e;
          }
        };

        const callOpenAICompatibleAnalysis = async (userPrompt, systemPrompt, images, apiKey, baseUrl, model) => {
            const content = [
                { type: "text", text: userPrompt },
                ...images.map(img => ({
                    type: "image_url",
                    image_url: { url: `data:image/jpeg;base64,${img}` }
                }))
            ];

            const url = `${baseUrl}/chat/completions`;
            try {
                const response = await fetchWithTimeout(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: content }
                        ],
                        max_tokens: 1000,
                        response_format: { type: "json_object" } 
                    })
                }, 30000);

                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(`API Error (${model}): ${err.error?.message || response.statusText}`);
                }
                const data = await response.json();
                const text = data.choices[0].message.content;
                const cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(cleanText);
            } catch (e) {
                if (e.name === 'AbortError') throw new Error("请求超时，请检查网络");
                throw new Error(`模型返回解析错误: ${e.message}`);
            }
        };

        const callOpenAICompatibleRendering = async (prompt, imageBase64, apiKey, baseUrl, model) => {
            const url = `${baseUrl}/images/generations`;
            try {
                const response = await fetchWithTimeout(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        prompt: prompt,
                        n: 1,
                        size: "1024x1024",
                        response_format: "b64_json"
                    })
                }, 45000);

                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(`Render API Error (${model}): ${err.error?.message || response.statusText}`);
                }
                const data = await response.json();
                return data.data[0].b64_json;
            } catch (e) {
                if (e.name === 'AbortError') throw new Error("渲染超时，请检查网络");
                throw e;
            }
        };

        // --- UI 组件 ---
        // (UI Components remain mostly same, glass effect tweaked for new background)

        const GlassCard = ({ children, className = "", onClick, hoverEffect = false }) => (
          <div 
            onClick={onClick}
            className={`
              glass-card rounded-2xl overflow-hidden transition-all duration-300
              ${hoverEffect ? 'active:scale-[0.98] active:bg-white/5' : ''}
              ${className}
            `}
          >
            {children}
          </div>
        );

        const Badge = ({ children, variant = "default" }) => {
          const styles = {
            default: "bg-white/5 text-zinc-400 border border-white/5",
            accent: "bg-cyan-500/10 text-cyan-300 border border-cyan-500/20 shadow-[0_0_10px_rgba(34,211,238,0.1)]",
          };
          return (
            <span className={`px-2.5 py-1 text-[10px] font-medium uppercase tracking-widest rounded-full backdrop-blur-md ${styles[variant]}`}>
              {children}
            </span>
          );
        };

        const Button = ({ children, onClick, disabled, variant = "primary", iconName, className = "", size = "md" }) => {
          const sizes = { sm: "px-4 py-3 text-xs", md: "px-6 py-4 text-sm", lg: "px-8 py-5 text-base" };
          const baseStyle = `relative overflow-hidden group flex items-center justify-center gap-2 rounded-xl font-medium tracking-wide transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none active:scale-[0.97]`;
          const variants = {
            primary: "bg-white text-black active:bg-zinc-200 shadow-lg",
            secondary: "bg-zinc-800/80 text-white active:bg-zinc-700/80 border border-white/5 backdrop-blur-md",
            cyber: "bg-gradient-to-r from-cyan-600 to-blue-600 text-white shadow-[0_0_20px_rgba(8,145,178,0.4)] active:shadow-none border border-cyan-400/20",
          };
          return (
            <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${sizes[size]} ${variants[variant]} ${className}`}>
              <div className="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite] pointer-events-none" />
              <span className="relative flex items-center gap-2 z-10">
                {iconName && <Icon name={iconName} size={size === 'sm' ? 16 : 20} />}
                {children}
              </span>
            </button>
          );
        };

        const FileUploader = ({ label, onUpload, currentImage, id, compact = false }) => {
          const fileInputRef = useRef(null);
          const handleFileChange = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onloadend = () => onUpload(reader.result, reader.result.split(',')[1]);
              reader.readAsDataURL(file);
            }
          };
          return (
            <div 
              className={`
                group relative w-full ${compact ? 'aspect-square' : 'aspect-video'} 
                bg-zinc-900/30 border border-dashed border-zinc-700/50 rounded-xl 
                active:border-cyan-500/50 active:bg-zinc-800/30 transition-all duration-300 
                flex flex-col items-center justify-center overflow-hidden cursor-pointer
                touch-manipulation
              `}
              onClick={() => fileInputRef.current.click()}
            >
              {currentImage ? (
                <>
                  <img src={currentImage} alt="Preview" className="w-full h-full object-cover opacity-80" />
                  <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                      <Badge variant="default">更换</Badge>
                  </div>
                  <div className="absolute top-2 right-2 p-2 bg-black/60 backdrop-blur rounded-full active:bg-red-500/80 transition-colors z-20" 
                       onClick={(e) => { e.stopPropagation(); onUpload(null, null); }}>
                     <Icon name="X" size={14} className="text-white"/>
                  </div>
                </>
              ) : (
                <div className="text-center p-4 relative z-10">
                  <div className="w-12 h-12 mx-auto mb-3 rounded-full bg-zinc-800/50 flex items-center justify-center active:scale-110 active:bg-cyan-500/20 transition-all duration-300">
                    {compact ? <Icon name="Plus" className="h-5 w-5 text-zinc-500" /> : <Icon name="Upload" className="h-6 w-6 text-zinc-500" />}
                  </div>
                  {!compact && <p className="text-xs text-zinc-500 tracking-widest font-medium">{label}</p>}
                </div>
              )}
              <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept="image/*" />
              <div className="absolute top-2 left-2 pointer-events-none">
                 <span className="text-[9px] font-mono text-zinc-500 bg-black/40 backdrop-blur px-1.5 py-0.5 rounded-md border border-white/5">{id}</span>
              </div>
            </div>
          );
        };

        const SettingsModal = ({ isOpen, onClose, config, onSave }) => {
          const [localConfig, setLocalConfig] = useState(config);
          const [activeTab, setActiveTab] = useState('analysis'); 
          const [visible, setVisible] = useState(false);

          useEffect(() => { 
              if (isOpen) { setVisible(true); setLocalConfig(config); } 
              else { setTimeout(() => setVisible(false), 500); }
          }, [isOpen, config]);

          if (!visible && !isOpen) return null;
          const currentModels = MODEL_OPTIONS[activeTab];

          return (
            <div className="fixed inset-0 z-[9999] flex items-end justify-center">
              <div className={`absolute inset-0 modal-backdrop transition-opacity duration-500 ${isOpen ? 'opacity-100' : 'opacity-0'}`} onClick={onClose} />
              <div className={`w-full max-w-lg bg-[#121214] rounded-t-[2.5rem] border-t border-white/10 shadow-2xl overflow-hidden flex flex-col max-h-[90vh] ${isOpen ? 'animate-slideUpSpring' : 'animate-slideDownSpring'}`}>
                <div className="w-full flex justify-center pt-3 pb-2" onClick={onClose}>
                    <div className="w-10 h-1.5 bg-zinc-700 rounded-full opacity-50"></div>
                </div>
                <div className="px-6 pb-4 pt-2 flex items-center justify-between">
                    <h3 className="text-xl font-semibold text-white tracking-tight flex items-center gap-2">
                      <Icon name="Settings" size={24} className="text-cyan-400" />
                      引擎配置
                    </h3>
                    <button onClick={onClose} className="bg-zinc-800 p-2 rounded-full text-zinc-400 hover:text-white transition-colors"><Icon name="X" size={20} /></button>
                </div>
                <div className="mx-6 p-1 bg-zinc-900 rounded-xl grid grid-cols-2 gap-1 mb-2">
                    {['analysis', 'rendering'].map(tab => (
                      <button key={tab} className={`py-2.5 text-sm font-semibold rounded-lg transition-all duration-300 ${activeTab === tab ? 'bg-zinc-800 text-white shadow-md' : 'text-zinc-500'}`} onClick={() => setActiveTab(tab)}>{tab === 'analysis' ? '视觉分析' : '图像生成'}</button>
                    ))}
                </div>
                <div className="flex-1 overflow-y-auto px-6 space-y-3 custom-scrollbar pb-8">
                    {currentModels.map((model) => {
                      const isSelected = (activeTab === 'analysis' ? localConfig.analysisProvider : localConfig.renderingProvider) === model.id;
                      return (
                      <div key={model.id} className={`p-4 rounded-2xl border transition-all duration-300 active:scale-[0.98] ${isSelected ? 'bg-cyan-500/10 border-cyan-500/50' : 'bg-zinc-800/40 border-white/5'}`} onClick={() => setLocalConfig(prev => ({ ...prev, [activeTab === 'analysis' ? 'analysisProvider' : 'renderingProvider']: model.id }))}>
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center transition-colors ${isSelected ? 'border-cyan-400' : 'border-zinc-600'}`}>
                              {isSelected && <div className="w-2.5 h-2.5 rounded-full bg-cyan-400" />}
                            </div>
                            <div className="flex flex-col">
                                <span className={`font-medium text-sm ${isSelected ? 'text-white' : 'text-zinc-300'}`}>{model.name}</span>
                                {isSelected && <span className="text-[10px] text-zinc-500 font-mono mt-0.5">{model.realModel}</span>}
                            </div>
                          </div>
                          {isSelected && <Icon name="Lock" size={14} className="text-cyan-400" />}
                        </div>
                        {/* Always show input for selected model because ALL models need keys in Client-side apps */}
                        {isSelected && (
                          <div className="mt-3 pl-8 animate-[fadeIn_0.3s_ease]">
                            <input 
                                type="password" 
                                placeholder={model.provider === 'gemini' ? "请输入 Gemini API Key (必填)" : `输入 ${model.name.split(' ')[0]} API Key`}
                                className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-3 text-sm text-white placeholder:text-zinc-600 focus:border-cyan-500/50 outline-none transition-colors font-mono"
                                value={localConfig.apiKeys[model.id] || ''}
                                onChange={(e) => setLocalConfig(prev => ({ ...prev, apiKeys: { ...prev.apiKeys, [model.id]: e.target.value } }))}
                                onClick={(e) => e.stopPropagation()}
                            />
                            {model.provider === 'gemini' && !localConfig.apiKeys[model.id] && (
                                <p className="text-[10px] text-zinc-500 mt-2">
                                    * 浏览器端运行需要 API Key，
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-cyan-400 underline ml-1">点击免费获取</a>
                                </p>
                            )}
                          </div>
                        )}
                      </div>
                      );
                    })}
                </div>
                <div className="p-6 bg-[#121214] border-t border-white/5 pb-10">
                    <Button variant="cyber" className="w-full h-14 text-lg" onClick={() => { onSave(localConfig); onClose(); }}>确认并应用</Button>
                </div>
              </div>
            </div>
          );
        };

        const CMFAnalysisPanel = ({ data, isLoading, providerName }) => {
          if (isLoading) {
            return (
              <GlassCard className="h-64 flex flex-col items-center justify-center p-6 border-cyan-500/20 bg-cyan-900/5 relative overflow-hidden">
                 <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,rgba(34,211,238,0.1),transparent_70%)] animate-pulse" />
                 <div className="w-16 h-16 border-t-2 border-l-2 border-cyan-400 rounded-full animate-spin mb-4 shadow-[0_0_30px_rgba(34,211,238,0.2)]" />
                 <p className="text-cyan-400 font-mono text-sm tracking-widest animate-pulse">深度分析中...</p>
                 <p className="text-zinc-500 text-[10px] mt-2 uppercase font-mono">Model: {providerName}</p>
              </GlassCard>
            );
          }
          if (!data) {
            return (
              <GlassCard className="h-32 flex flex-col items-center justify-center p-4 bg-zinc-900/20 border-dashed border-zinc-800">
                <div className="flex items-center gap-2 text-zinc-600">
                    <Icon name="Layers" size={20} />
                    <span className="text-sm font-light">请先上传上方参考图</span>
                </div>
              </GlassCard>
            );
          }
          return (
            <GlassCard className="p-0 border-cyan-500/20 bg-zinc-900/60 flex flex-col animate-fadeIn">
              <div className="p-4 border-b border-white/5 bg-white/5 flex justify-between items-center backdrop-blur-md">
                <h3 className="font-bold text-zinc-100 flex items-center gap-2 text-sm">
                  <div className="w-6 h-6 rounded bg-cyan-500/20 flex items-center justify-center"><Icon name="Zap" size={12} className="text-cyan-400" /></div>
                  分析报告
                </h3>
                <Badge variant="accent">Done</Badge>
              </div>
              <div className="p-5 space-y-4">
                <div>
                  <label className="text-zinc-500 text-[10px] uppercase tracking-wider block mb-1">Color Identity</label>
                  <div className="text-lg text-transparent bg-clip-text bg-gradient-to-r from-white to-zinc-400 font-light tracking-tight">{data.color_name}</div>
                  <p className="text-xs text-zinc-500 mt-1">{data.hsv_analysis}</p>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-zinc-500 text-[10px] uppercase tracking-wider block mb-1">Type</label>
                    <div className="flex items-center gap-2 text-zinc-300 text-xs"><Icon name="Palette" size={12} className="text-purple-400" /> {data.paint_type}</div>
                  </div>
                  <div>
                    <label className="text-zinc-500 text-[10px] uppercase tracking-wider block mb-1">Gloss</label>
                    <div className="flex items-center gap-2 text-zinc-300 text-xs"><Icon name="Droplet" size={12} className="text-cyan-400" /> {data.gloss_level}</div>
                  </div>
                </div>
                <div className="bg-white/5 p-3 rounded-lg border border-white/5">
                   <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="text-zinc-500 text-[9px] uppercase tracking-wider block mb-1">Flakes</label>
                            <p className="text-zinc-300 text-[11px] leading-relaxed">{data.flake_character}</p>
                        </div>
                         <div>
                            <label className="text-zinc-500 text-[9px] uppercase tracking-wider block mb-1">Texture</label>
                            <p className="text-zinc-300 text-[11px] leading-relaxed">{data.visual_texture}</p>
                        </div>
                   </div>
                </div>
                <div className="bg-white/5 p-3 rounded-lg border border-white/5">
                  <label className="text-zinc-500 text-[9px] uppercase tracking-wider block mb-1">Flip-Flop (随角异色)</label>
                  <p className="text-zinc-300 text-[11px] leading-relaxed font-mono">{data.travel_effect}</p>
                </div>
              </div>
            </GlassCard>
          );
        };

        const ComparisonGallery = ({ original, generated, label, isProcessing, providerName }) => {
          if (!original && !generated) return null;
          return (
            <div className="mb-6 group">
              <div className="flex items-center justify-between mb-3 px-1">
                <h4 className="text-sm font-semibold text-zinc-400 tracking-tight flex items-center gap-2">
                  <span className="w-1.5 h-1.5 bg-cyan-500 rounded-full" /> {label}
                </h4>
                {isProcessing && <span className="text-[10px] text-amber-500 animate-pulse font-mono">Generating...</span>}
              </div>
              <div className="flex flex-col gap-3">
                <GlassCard className="relative aspect-video bg-black/40 border-0">
                  {original ? <img src={original} className="w-full h-full object-cover opacity-80" alt="Orig" /> : <div className="text-zinc-700 m-auto">空</div>}
                  <div className="absolute top-2 left-2"><Badge variant="default">Original</Badge></div>
                </GlassCard>
                <div className="flex justify-center -my-4 relative z-10">
                    <div className="bg-zinc-900 rounded-full p-1 border border-zinc-700">
                        <Icon name="ArrowRight" size={14} className="text-zinc-500 rotate-90" />
                    </div>
                </div>
                <GlassCard className={`relative aspect-video bg-black/40 border-0 transition-all duration-500 ${isProcessing ? 'border-amber-500/30' : 'border-cyan-500/30'}`}>
                   {isProcessing ? (
                     <div className="w-full h-full flex flex-col items-center justify-center relative overflow-hidden">
                        <div className="absolute inset-0 bg-gradient-to-b from-amber-500/10 to-transparent animate-pulse" />
                        <div className="w-8 h-8 border-2 border-amber-500 border-t-transparent rounded-full animate-spin mb-3" />
                        <span className="text-[9px] text-amber-500 font-mono tracking-widest">渲染中 // {providerName}</span>
                     </div>
                   ) : generated ? (
                     <img src={generated.startsWith('data:') ? generated : `data:image/jpeg;base64,${generated}`} className="w-full h-full object-cover" alt="Gen" />
                   ) : (
                     <div className="w-full h-full flex items-center justify-center text-zinc-700 border-2 border-dashed border-zinc-800"><span className="text-xs text-zinc-600">等待生成</span></div>
                   )}
                   {generated && !isProcessing && <div className="absolute top-2 left-2"><Badge variant="accent">AI Render</Badge></div>}
                </GlassCard>
              </div>
            </div>
          );
        };

        function App() {
          const [targetImages, setTargetImages] = useState([null, null, null]); 
          const [targetImagesRaw, setTargetImagesRaw] = useState([null, null, null]); 
          const [referenceImages, setReferenceImages] = useState([null, null, null]);
          const [referenceImagesRaw, setReferenceImagesRaw] = useState([null, null, null]);
          const [analysisResult, setAnalysisResult] = useState(null);
          const [generatedImages, setGeneratedImages] = useState([null, null, null]);
          const [status, setStatus] = useState("IDLE"); 
          const [errorMessage, setErrorMessage] = useState("");
          const [isSettingsOpen, setIsSettingsOpen] = useState(false);
          const [appConfig, setAppConfig] = useState({ 
              analysisProvider: 'gemini_default', 
              renderingProvider: 'gemini_default', 
              apiKeys: {}
          });

          const mainRef = useRef(null);
          useEffect(() => {
              if (mainRef.current) {
                  if (isSettingsOpen) {
                      mainRef.current.classList.add('animate-scaleDown');
                      mainRef.current.classList.remove('animate-scaleUp');
                  } else {
                      mainRef.current.classList.add('animate-scaleUp');
                      mainRef.current.classList.remove('animate-scaleDown');
                  }
              }
          }, [isSettingsOpen]);

          useEffect(() => {
              const savedConfig = localStorage.getItem('cmf_lab_config_v3');
              if (savedConfig) {
                  try { setAppConfig(JSON.parse(savedConfig)); } catch (e) {}
              }
          }, []);

          const handleSaveConfig = (newConfig) => {
              setAppConfig(newConfig);
              localStorage.setItem('cmf_lab_config_v3', JSON.stringify(newConfig));
          };

          const handleTargetUpload = (i, url, raw) => { const n=[...targetImages],nr=[...targetImagesRaw]; n[i]=url; nr[i]=raw; setTargetImages(n); setTargetImagesRaw(nr); };
          const handleReferenceUpload = (i, url, raw) => { const n=[...referenceImages],nr=[...referenceImagesRaw]; n[i]=url; nr[i]=raw; setReferenceImages(n); setReferenceImagesRaw(nr); setAnalysisResult(null); setStatus("IDLE"); };

          const runAnalysis = async () => {
            if (referenceImagesRaw.every(img => img === null)) return;
            setStatus("ANALYZING"); setErrorMessage("");
            try { 
                const providerId = appConfig.analysisProvider;
                const apiKey = appConfig.apiKeys[providerId];
                setAnalysisResult(await analyzePaintCMF(referenceImagesRaw, { providerId, apiKey })); 
                setStatus("ANALYZED"); 
            } catch (e) { 
                setErrorMessage(e.message || "分析失败"); 
                setStatus("ERROR"); 
            }
          };

          const runSynthesis = async () => {
            if (!analysisResult) return;
            setStatus("RENDERING"); setErrorMessage("");
            try {
              const providerId = appConfig.renderingProvider;
              const apiKey = appConfig.apiKeys[providerId];
              const results = await Promise.all(targetImagesRaw.map(async (imgRaw, index) => {
                if (!imgRaw) return null;
                return await renderCarPaint(imgRaw, analysisResult, { providerId, apiKey });
              }));
              setGeneratedImages(results); setStatus("COMPLETED");
            } catch (e) { 
                setErrorMessage(e.message || "渲染失败"); 
                setStatus("ERROR"); 
            }
          };

          const refCount = referenceImages.filter(Boolean).length;
          const getCurrentModelName = (type) => {
            const providerId = type === 'analysis' ? appConfig.analysisProvider : appConfig.renderingProvider;
            const model = MODEL_OPTIONS[type].find(m => m.id === providerId);
            return model ? model.name.split('(')[0].trim() : 'Unknown';
          };

          return (
            <div className="min-h-screen font-sans relative bg-black overflow-hidden selection:bg-cyan-500/30 selection:text-cyan-200">
              {/* Dynamic Background */}
              <div className="fixed inset-0 z-0 pointer-events-none">
                 {/* Tech Grid Overlay */}
                 <div className="absolute inset-0 tech-bg-grid bg-tech-grid opacity-30"></div>
                 {/* Moving Blobs */}
                 <div className="absolute top-[-20%] left-[-10%] w-[80vw] h-[80vw] bg-purple-900/10 rounded-full blur-[120px] animate-blob mix-blend-screen" />
                 <div className="absolute top-[20%] right-[-10%] w-[60vw] h-[60vw] bg-cyan-900/10 rounded-full blur-[100px] animate-blob animation-delay-2000 mix-blend-screen" />
                 <div className="absolute bottom-[-20%] left-[20%] w-[70vw] h-[70vw] bg-blue-900/10 rounded-full blur-[120px] animate-blob animation-delay-4000 mix-blend-screen" />
              </div>

              <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} config={appConfig} onSave={handleSaveConfig} />

              <div ref={mainRef} className="min-h-screen origin-top transition-transform duration-500">
                  <nav className="fixed top-0 left-0 right-0 z-50 bg-[#050505]/80 backdrop-blur-xl border-b border-white/5 pt-[env(safe-area-inset-top)]">
                    <div className="px-5 h-16 flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="w-9 h-9 bg-gradient-to-br from-zinc-800 to-black rounded-lg border border-white/10 flex items-center justify-center relative overflow-hidden shadow-lg group">
                           <div className="absolute inset-0 bg-gradient-to-tr from-cyan-500/20 to-purple-500/20 opacity-50 group-hover:opacity-100 transition-opacity" />
                           <Icon name="CarFront" size={18} className="text-zinc-200 relative z-10" />
                        </div>
                        <h1 className="font-bold tracking-tight text-lg leading-none font-mono text-zinc-200">
                            {APP_TITLE} <span className="text-cyan-500 text-base">{APP_SUFFIX}</span>
                        </h1>
                      </div>
                      <Button variant="ghost" size="sm" onClick={() => setIsSettingsOpen(true)} className="!px-2">
                        <Icon name="Settings" size={20} />
                      </Button>
                    </div>
                  </nav>

                  <main className="relative z-10 pt-[calc(4rem+env(safe-area-inset-top))] pb-24 px-5 max-w-lg mx-auto md:max-w-4xl">
                    <section className="py-8 mb-6 text-center">
                      <h2 className="text-4xl font-bold text-white mb-2 tracking-tight drop-shadow-lg">
                        虚拟 <span className="liquid-text font-black">涂装实验室</span>
                      </h2>
                      {/* Subtitle Added */}
                      <p className="text-[10px] text-zinc-500 tracking-[0.3em] uppercase font-medium animate-fadeIn">
                          次世代 CMF 可视化引擎 <span className="text-zinc-700 mx-1">|</span> Powered by Owlharry
                      </p>

                      <div className="flex justify-center gap-2 mt-6 flex-wrap">
                         <span className="text-[10px] bg-purple-500/5 border border-purple-500/20 text-purple-300 px-3 py-1 rounded-full flex items-center gap-1.5 backdrop-blur-md">
                            <span className="w-1.5 h-1.5 bg-purple-400 rounded-full animate-pulse"/> 分析: {getCurrentModelName('analysis')}
                         </span>
                         <span className="text-[10px] bg-cyan-500/5 border border-cyan-500/20 text-cyan-300 px-3 py-1 rounded-full flex items-center gap-1.5 backdrop-blur-md">
                            <span className="w-1.5 h-1.5 bg-cyan-400 rounded-full animate-pulse"/> 生成: {getCurrentModelName('rendering')}
                         </span>
                      </div>
                      {status === "ERROR" && (
                        <div className="mt-6 flex items-center justify-center gap-3 text-red-400 bg-red-950/20 backdrop-blur px-4 py-3 rounded-xl border border-red-900/50 shadow-lg animate-fadeIn max-w-sm mx-auto">
                           <Icon name="AlertCircle" size={16} /> <span className="text-xs font-medium">{errorMessage}</span>
                        </div>
                      )}
                    </section>

                    <div className="flex flex-col gap-10">
                      <section className="space-y-4">
                        <div className="flex items-center justify-between px-1">
                          <h3 className="text-xl font-semibold text-white tracking-tight flex items-center gap-3">
                             <div className="w-6 h-6 rounded-full bg-zinc-800 border border-zinc-700 flex items-center justify-center text-xs font-bold text-cyan-400 shadow-[0_0_15px_rgba(34,211,238,0.2)]">1</div> 
                             材质参考
                          </h3>
                          <span className="text-[10px] text-zinc-500 font-mono bg-white/5 px-2 py-0.5 rounded-full border border-white/5">{refCount} / 3</span>
                        </div>
                        <div className="grid grid-cols-3 gap-3">
                            {[0,1,2].map(i => (
                              <FileUploader key={i} id={`R${i+1}`} label={`图${i+1}`} compact={true} onUpload={(url, raw) => handleReferenceUpload(i, url, raw)} currentImage={referenceImages[i]} />
                            ))}
                        </div>
                        <Button 
                          variant={status === "ANALYZING" ? "secondary" : "primary"}
                          className="w-full shadow-2xl shadow-purple-900/10 h-14"
                          onClick={runAnalysis}
                          disabled={refCount === 0 || status === "ANALYZING"}
                          iconName={status === "ANALYZING" ? null : "Zap"}
                        >
                          {status === "ANALYZING" ? "正在分析特征..." : "开始 CMF 提取"} 
                        </Button>
                        <CMFAnalysisPanel data={analysisResult} isLoading={status === "ANALYZING"} providerName={getCurrentModelName('analysis')} />
                      </section>

                      <section className={`space-y-4 transition-all duration-700 ${!analysisResult ? 'opacity-40 blur-[2px] pointer-events-none grayscale' : 'opacity-100 blur-0'}`}>
                         <div className="flex items-center justify-between px-1">
                           <h3 className="text-xl font-semibold text-white tracking-tight flex items-center gap-3">
                             <div className="w-6 h-6 rounded-full bg-zinc-800 border border-zinc-700 flex items-center justify-center text-xs font-bold text-purple-400 shadow-[0_0_15px_rgba(192,132,252,0.2)]">2</div> 
                             目标车辆
                           </h3>
                         </div>
                         <div className="grid grid-cols-3 gap-3">
                            <FileUploader id="前" label="前" compact={true} currentImage={targetImages[0]} onUpload={(url, raw) => handleTargetUpload(0, url, raw)} />
                            <FileUploader id="侧" label="侧" compact={true} currentImage={targetImages[1]} onUpload={(url, raw) => handleTargetUpload(1, url, raw)} />
                            <FileUploader id="后" label="后" compact={true} currentImage={targetImages[2]} onUpload={(url, raw) => handleTargetUpload(2, url, raw)} />
                         </div>
                         <Button 
                           variant="cyber" 
                           size="lg"
                           className="w-full mt-2 h-14"
                           disabled={status !== "ANALYZED" && status !== "COMPLETED"} 
                           onClick={runSynthesis}
                           iconName={status === "RENDERING" ? null : "Sparkles"}
                         >
                           {status === "RENDERING" ? "AI 正在绘制..." : "启动喷涂程序"}
                         </Button>
                      </section>

                      { (status === "RENDERING" || status === "COMPLETED") && (
                         <section className="space-y-6 pt-6 border-t border-white/5 animate-fadeIn">
                            <div className="flex items-center justify-between px-1">
                               <h3 className="text-xl font-semibold text-white tracking-tight flex items-center gap-2">
                                 <Icon name="Maximize2" size={18} className="text-amber-400"/> 最终交付
                               </h3>
                            </div>
                            <div className="space-y-10">
                               {['前视视角', '侧视视角', '后视视角'].map((label, i) => (
                                  <ComparisonGallery 
                                    key={i} 
                                    label={label} 
                                    original={targetImages[i]} 
                                    generated={generatedImages[i]} 
                                    isProcessing={status === "RENDERING"} 
                                    providerName={getCurrentModelName('rendering')} 
                                  />
                               ))}
                            </div>
                         </section>
                      )}
                    </div>
                  </main>
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
